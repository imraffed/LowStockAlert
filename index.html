<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Analysis Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .upload-container {
            background-color: #f9f9f9;
            border: 2px dashed #ccc;
            border-radius: 5px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }
        #fileInput {
            display: none;
        }
        .upload-btn {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 15px;
        }
        .upload-btn:hover {
            background-color: #2980b9;
        }
        #fileName {
            margin-top: 10px;
            font-style: italic;
        }
        #analyzeBtn {
            background-color: #2ecc71;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            margin: 20px auto;
        }
        #analyzeBtn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        #analyzeBtn:hover:not(:disabled) {
            background-color: #27ae60;
        }
        .results {
            margin-top: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .highlight {
            background-color: #fffacd;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .instructions {
            background-color: #eaf7fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .column-selector {
            background-color: #f0f8ff;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .column-selector select {
            padding: 5px;
            margin-right: 15px;
            min-width: 150px;
        }
        .preview-table {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
            border: 1px solid #ddd;
        }
        .preview-table table {
            margin: 0;
        }
        .settings-section {
            background-color: #fffaf0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .settings-section label {
            display: inline-block;
            width: 250px;
            margin: 5px 0;
        }
        .settings-section input, .settings-section textarea {
            padding: 5px;
        }
        .settings-section input[type="number"] {
            width: 60px;
        }
        .settings-section textarea {
            width: 300px;
            height: 60px;
        }
        .analysis-type {
            margin: 15px 0;
        }
        .analysis-type label {
            margin-right: 15px;
            cursor: pointer;
        }
        .analysis-type input {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <h1>Inventory Analysis Tool</h1>
    
    <div class="instructions">
        <h3>Instructions:</h3>
        <ol>
            <li>Upload your inventory CSV file</li>
            <li>Select which columns contain the product name, location, and quantity</li>
            <li>Choose analysis type (compare Sales Floor vs Vault or analyze all rooms)</li>
            <li>Configure analysis settings</li>
            <li>Click "Analyze Inventory"</li>
        </ol>
    </div>
    
    <div class="upload-container">
        <input type="file" id="fileInput" accept=".csv">
        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Choose CSV File</button>
        <div id="fileName">No file selected</div>
    </div>
    
    <div id="columnSelector" class="column-selector" style="display: none;">
        <h3>Map Your CSV Columns</h3>
        <div>
            <label for="productColumn">Product Name/ID Column:</label>
            <select id="productColumn"></select>
        </div>
        <div>
            <label for="locationColumn">Location/Room Column:</label>
            <select id="locationColumn"></select>
        </div>
        <div>
            <label for="quantityColumn">Quantity Column:</label>
            <select id="quantityColumn"></select>
        </div>
        
        <div id="previewSection" style="display: none;">
            <h4>Data Preview (first 5 rows):</h4>
            <div class="preview-table">
                <table id="previewTable">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="settings-section">
        <h3>Analysis Settings</h3>
        
        <div class="analysis-type">
            <strong>Analysis Type:</strong>
            <label>
                <input type="radio" name="analysisType" value="floorVault" checked> Compare Sales Floor vs Vault
            </label>
            <label>
                <input type="radio" name="analysisType" value="allRooms"> Analyze all rooms for low stock
            </label>
        </div>
        
        <div id="floorVaultSettings">
            <div>
                <label for="floorLocationNames">Floor location names (comma separated):</label>
                <textarea id="floorLocationNames">sales floor,floor,showroom</textarea>
            </div>
            <div>
                <label for="vaultLocationNames">Vault location names (comma separated):</label>
                <textarea id="vaultLocationNames">vault,backroom,storage,warehouse</textarea>
            </div>
            <div>
                <label for="lowStockThreshold">Low stock threshold (quantity):</label>
                <input type="number" id="lowStockThreshold" value="5" min="1">
            </div>
        </div>
        
        <div id="allRoomsSettings" style="display: none;">
            <div>
                <label for="primaryRoomNames">Primary room names (comma separated):</label>
                <textarea id="primaryRoomNames">sales floor,floor,showroom</textarea>
            </div>
            <div>
                <label for="allRoomsThreshold">Low stock threshold (quantity):</label>
                <input type="number" id="allRoomsThreshold" value="5" min="1">
            </div>
        </div>
    </div>
    
    <button id="analyzeBtn" disabled>Analyze Inventory</button>
    
    <div class="results">
        <h2>Analysis Results</h2>
        <div id="resultsContainer"></div>
    </div>

    <script>
        let inventoryData = [];
        let csvHeaders = [];
        
        // File input change handler
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = `Selected: ${file.name}`;
                
                // Read the file
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    parseCSV(content);
                };
                reader.readAsText(file);
            }
        });
        
        // Analysis type change handler
        document.querySelectorAll('input[name="analysisType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'floorVault') {
                    document.getElementById('floorVaultSettings').style.display = 'block';
                    document.getElementById('allRoomsSettings').style.display = 'none';
                } else {
                    document.getElementById('floorVaultSettings').style.display = 'none';
                    document.getElementById('allRoomsSettings').style.display = 'block';
                }
            });
        });
        
        // Parse CSV content
        function parseCSV(content) {
            const lines = content.split('\n').filter(line => line.trim() !== '');
            csvHeaders = lines[0].split(',').map(h => h.trim());
            
            // Populate column selectors
            const productSelect = document.getElementById('productColumn');
            const locationSelect = document.getElementById('locationColumn');
            const quantitySelect = document.getElementById('quantityColumn');
            
            // Clear existing options
            productSelect.innerHTML = '';
            locationSelect.innerHTML = '';
            quantitySelect.innerHTML = '';
            
            // Add options for each header
            csvHeaders.forEach(header => {
                if (header) {
                    const option1 = document.createElement('option');
                    option1.value = header;
                    option1.textContent = header;
                    productSelect.appendChild(option1.cloneNode(true));
                    
                    const option2 = option1.cloneNode(true);
                    locationSelect.appendChild(option2);
                    
                    const option3 = option1.cloneNode(true);
                    quantitySelect.appendChild(option3);
                }
            });
            
            // Try to auto-detect likely columns
            autoDetectColumns();
            
            // Show the column selector
            document.getElementById('columnSelector').style.display = 'block';
            
            // Create preview table
            createPreviewTable(lines.slice(0, 6)); // First 5 data rows + header
            document.getElementById('previewSection').style.display = 'block';
            
            // Enable analyze button when all columns are selected
            checkAnalyzeButton();
        }
        
        // Auto-detect likely columns based on common names
        function autoDetectColumns() {
            const productSelect = document.getElementById('productColumn');
            const locationSelect = document.getElementById('locationColumn');
            const quantitySelect = document.getElementById('quantityColumn');
            
            const productKeywords = ['product', 'name', 'id', 'item', 'sku'];
            const locationKeywords = ['location', 'room', 'area', 'place', 'store'];
            const quantityKeywords = ['quantity', 'qty', 'stock', 'count', 'amount'];
            
            // Find best match for product column
            for (let i = 0; i < productSelect.options.length; i++) {
                const option = productSelect.options[i];
                const lowerText = option.text.toLowerCase();
                if (productKeywords.some(kw => lowerText.includes(kw))) {
                    productSelect.selectedIndex = i;
                    break;
                }
            }
            
            // Find best match for location column
            for (let i = 0; i < locationSelect.options.length; i++) {
                const option = locationSelect.options[i];
                const lowerText = option.text.toLowerCase();
                if (locationKeywords.some(kw => lowerText.includes(kw))) {
                    locationSelect.selectedIndex = i;
                    break;
                }
            }
            
            // Find best match for quantity column
            for (let i = 0; i < quantitySelect.options.length; i++) {
                const option = quantitySelect.options[i];
                const lowerText = option.text.toLowerCase();
                if (quantityKeywords.some(kw => lowerText.includes(kw))) {
                    quantitySelect.selectedIndex = i;
                    break;
                }
            }
        }
        
        // Create preview table
        function createPreviewTable(lines) {
            const previewTable = document.getElementById('previewTable');
            const thead = previewTable.querySelector('thead');
            const tbody = previewTable.querySelector('tbody');
            
            // Clear existing content
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            // Add headers
            const headerRow = document.createElement('tr');
            lines[0].split(',').forEach(header => {
                const th = document.createElement('th');
                th.textContent = header.trim();
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            
            // Add data rows
            for (let i = 1; i < lines.length && i < 6; i++) {
                const row = document.createElement('tr');
                lines[i].split(',').forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell.trim();
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            }
        }
        
        // Check if analyze button should be enabled
        function checkAnalyzeButton() {
            const productCol = document.getElementById('productColumn').value;
            const locationCol = document.getElementById('locationColumn').value;
            const quantityCol = document.getElementById('quantityColumn').value;
            
            document.getElementById('analyzeBtn').disabled = !(productCol && locationCol && quantityCol);
        }
        
        // Column select change handlers
        document.getElementById('productColumn').addEventListener('change', checkAnalyzeButton);
        document.getElementById('locationColumn').addEventListener('change', checkAnalyzeButton);
        document.getElementById('quantityColumn').addEventListener('change', checkAnalyzeButton);
        
        // Analyze button click handler
        document.getElementById('analyzeBtn').addEventListener('click', function() {
            // Get selected columns
            const productCol = document.getElementById('productColumn').value;
            const locationCol = document.getElementById('locationColumn').value;
            const quantityCol = document.getElementById('quantityColumn').value;
            
            // Get analysis type
            const analysisType = document.querySelector('input[name="analysisType"]:checked').value;
            
            // Read the file again with the selected columns
            const file = document.getElementById('fileInput').files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                inventoryData = parseCSVWithColumns(content, productCol, locationCol, quantityCol);
                
                let results;
                if (analysisType === 'floorVault') {
                    // Floor vs Vault analysis
                    const floorNames = document.getElementById('floorLocationNames').value
                        .split(',')
                        .map(name => name.trim().toLowerCase());
                    const vaultNames = document.getElementById('vaultLocationNames').value
                        .split(',')
                        .map(name => name.trim().toLowerCase());
                    const threshold = parseInt(document.getElementById('lowStockThreshold').value) || 5;
                    
                    results = analyzeFloorVault(inventoryData, floorNames, vaultNames, threshold);
                    displayFloorVaultResults(results, threshold);
                } else {
                    // All rooms analysis
                    const primaryNames = document.getElementById('primaryRoomNames').value
                        .split(',')
                        .map(name => name.trim().toLowerCase());
                    const threshold = parseInt(document.getElementById('allRoomsThreshold').value) || 5;
                    
                    results = analyzeAllRooms(inventoryData, primaryNames, threshold);
                    displayAllRoomsResults(results, threshold);
                }
            };
            reader.readAsText(file);
        });
        
        // Parse CSV with specific columns
        function parseCSVWithColumns(content, productCol, locationCol, quantityCol) {
            const lines = content.split('\n').filter(line => line.trim() !== '');
            const headers = lines[0].split(',').map(h => h.trim());
            
            // Get column indices
            const productIndex = headers.indexOf(productCol);
            const locationIndex = headers.indexOf(locationCol);
            const quantityIndex = headers.indexOf(quantityCol);
            
            if (productIndex === -1 || locationIndex === -1 || quantityIndex === -1) {
                throw new Error("Could not find one or more specified columns in the CSV file.");
            }
            
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = lines[i].split(',');
                const productName = values[productIndex] ? values[productIndex].trim() : '';
                const room = values[locationIndex] ? values[locationIndex].trim() : '';
                const quantity = values[quantityIndex] ? parseInt(values[quantityIndex].trim()) || 0 : 0;
                
                if (productName && room) {
                    data.push({
                        productName,
                        room,
                        quantity
                    });
                }
            }
            
            return data;
        }
        
        // Analyze Floor vs Vault
        function analyzeFloorVault(data, floorNames, vaultNames, threshold) {
            // Group products by their name/ID
            const productMap = {};
            
            data.forEach(item => {
                if (!productMap[item.productName]) {
                    productMap[item.productName] = [];
                }
                
                productMap[item.productName].push({
                    room: item.room,
                    quantity: item.quantity
                });
            });
            
            // Find products with low floor stock but available in vault
            const results = [];
            
            for (const productName in productMap) {
                const locations = productMap[productName];
                const floorStock = locations.find(loc => 
                    floorNames.some(name => loc.room.toLowerCase().includes(name))
                );
                
                // Check if floor stock is at or below threshold
                if (floorStock && floorStock.quantity <= threshold) {
                    // Find vault locations with stock
                    const vaultStock = locations.filter(loc => 
                        vaultNames.some(name => loc.room.toLowerCase().includes(name)) && 
                        loc.quantity > 0
                    );
                    
                    if (vaultStock.length > 0) {
                        results.push({
                            productName,
                            floorQuantity: floorStock.quantity,
                            vaultLocations: vaultStock
                        });
                    }
                }
            }
            
            return results;
        }
        
        // Analyze All Rooms
        function analyzeAllRooms(data, primaryNames, threshold) {
            // Group products by their name/ID
            const productMap = {};
            
            data.forEach(item => {
                if (!productMap[item.productName]) {
                    productMap[item.productName] = [];
                }
                
                productMap[item.productName].push({
                    room: item.room,
                    quantity: item.quantity
                });
            });
            
            // Find products with low primary room stock but available elsewhere
            const results = [];
            
            for (const productName in productMap) {
                const locations = productMap[productName];
                const primaryStock = locations.find(loc => 
                    primaryNames.some(name => loc.room.toLowerCase().includes(name))
                );
                
                // Check if primary stock is at or below threshold
                if (primaryStock && primaryStock.quantity <= threshold) {
                    // Find other rooms with stock (excluding primary rooms)
                    const otherRooms = locations.filter(loc => 
                        !primaryNames.some(name => loc.room.toLowerCase().includes(name)) && 
                        loc.quantity > 0
                    );
                    
                    if (otherRooms.length > 0) {
                        results.push({
                            productName,
                            primaryQuantity: primaryStock.quantity,
                            primaryRoom: primaryStock.room,
                            otherLocations: otherRooms
                        });
                    }
                }
            }
            
            return results;
        }
        
        // Display Floor vs Vault results
        function displayFloorVaultResults(results, threshold) {
            const container = document.getElementById('resultsContainer');
            
            if (results.length === 0) {
                container.innerHTML = `<p>No products found with ${threshold} or fewer items on the sales floor but available in the vault.</p>`;
                return;
            }
            
            let html = `
                <p>Found ${results.length} products with ${threshold} or fewer items on the sales floor but available in the vault:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Floor Quantity</th>
                            <th>Available In Vault</th>
                            <th>Vault Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            results.forEach(product => {
                product.vaultLocations.forEach((location, index) => {
                    html += `
                        <tr${index === 0 ? ' class="highlight"' : ''}>
                            ${index === 0 ? `<td rowspan="${product.vaultLocations.length}">${product.productName}</td>` : ''}
                            ${index === 0 ? `<td rowspan="${product.vaultLocations.length}">${product.floorQuantity}</td>` : ''}
                            <td>${location.room}</td>
                            <td>${location.quantity}</td>
                        </tr>
                    `;
                });
            });
            
            html += `
                    </tbody>
                </table>
                <p style="margin-top: 20px;">Highlighted rows show the first vault location for each product.</p>
            `;
            
            container.innerHTML = html;
        }
        
        // Display All Rooms results
        function displayAllRoomsResults(results, threshold) {
            const container = document.getElementById('resultsContainer');
            
            if (results.length === 0) {
                container.innerHTML = `<p>No products found with ${threshold} or fewer items in primary locations but available in other rooms.</p>`;
                return;
            }
            
            let html = `
                <p>Found ${results.length} products with ${threshold} or fewer items in primary locations but available in other rooms:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Primary Location</th>
                            <th>Primary Qty</th>
                            <th>Available In</th>
                            <th>Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            results.forEach(product => {
                product.otherLocations.forEach((location, index) => {
                    html += `
                        <tr${index === 0 ? ' class="highlight"' : ''}>
                            ${index === 0 ? `<td rowspan="${product.otherLocations.length}">${product.productName}</td>` : ''}
                            ${index === 0 ? `<td rowspan="${product.otherLocations.length}">${product.primaryRoom}</td>` : ''}
                            ${index === 0 ? `<td rowspan="${product.otherLocations.length}">${product.primaryQuantity}</td>` : ''}
                            <td>${location.room}</td>
                            <td>${location.quantity}</td>
                        </tr>
                    `;
                });
            });
            
            html += `
                    </tbody>
                </table>
                <p style="margin-top: 20px;">Highlighted rows show the first available location for each product.</p>
            `;
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>